import streamlit as st
import pandas as pd
import numpy as np
import utils
import os
from datetime import datetime

# Page config
st.set_page_config(page_title="SOR HPLC Testing", layout="wide")

# Initialize session state
if 'experiment_data' not in st.session_state:
    st.session_state.experiment_data = None
if 'completed' not in st.session_state:
    st.session_state.completed = 0
if 'phase' not in st.session_state:
    st.session_state.phase = 'setup'  # setup, lhs, sor, completed
if 'objectives' not in st.session_state:
    st.session_state.objectives = []
if 'sor_iteration' not in st.session_state:
    st.session_state.sor_iteration = 0
if 'num_lhs' not in st.session_state:
    st.session_state.num_lhs = 0

st.title("ðŸ§ª SOR HPLC Processing - Local Testing")

# Sidebar for configuration
with st.sidebar:
    st.header("Configuration")

    if st.session_state.phase == 'setup':
        st.subheader("1ï¸âƒ£ Upload LHS Data")
        lhs_file = st.file_uploader("Upload LHS Excel/CSV", type=['xlsx', 'csv'])

        if lhs_file:
            # Read LHS file
            if lhs_file.name.endswith('.csv'):
                lhs_df = pd.read_csv(lhs_file)
            else:
                lhs_df = pd.read_excel(lhs_file)

            st.success(f"âœ… Loaded {len(lhs_df)} LHS experiments")
            st.dataframe(lhs_df.head())

            st.subheader("2ï¸âƒ£ Define Objectives")

            num_objectives = st.number_input("Number of Objectives", min_value=1, max_value=5, value=2)

            objectives = []
            rtmin_list = []
            rtmax_list = []

            for i in range(num_objectives):
                st.markdown(f"**Objective {i+1}**")
                col1, col2 = st.columns(2)
                with col1:
                    obj_name = st.text_input(f"Name", value=f"Obj_{i+1}", key=f"obj_name_{i}")
                    rtmin = st.number_input(f"RT Min", value=0.0, key=f"rtmin_{i}", format="%.2f")
                with col2:
                    maximize = st.selectbox(f"Condition", ["Minimize", "Maximize"], key=f"maximize_{i}")
                    rtmax = st.number_input(f"RT Max", value=1.0, key=f"rtmax_{i}", format="%.2f")

                objectives.append({
                    "name": obj_name,
                    "maximize": maximize == "Maximize"
                })
                rtmin_list.append(rtmin)
                rtmax_list.append(rtmax)

            st.subheader("3ï¸âƒ£ Internal Standard RT Range")
            col1, col2 = st.columns(2)
            with col1:
                iso_rtmin = st.number_input("ISO RT Min", value=0.0, format="%.2f")
            with col2:
                iso_rtmax = st.number_input("ISO RT Max", value=30.0, format="%.2f")

            st.subheader("4ï¸âƒ£ SOR Configuration")
            num_sor_iterations = st.number_input("Number of SOR Iterations", min_value=1, max_value=20, value=5)

            if st.button("ðŸš€ Start Experiment"):
                # Add objective columns to LHS data
                for obj in objectives:
                    lhs_df[obj['name']] = ""

                st.session_state.experiment_data = lhs_df
                st.session_state.objectives = objectives
                st.session_state.rtmin_list = rtmin_list
                st.session_state.rtmax_list = rtmax_list
                st.session_state.iso_rtmin = iso_rtmin
                st.session_state.iso_rtmax = iso_rtmax
                st.session_state.num_lhs = len(lhs_df)
                st.session_state.num_sor_iterations = num_sor_iterations
                st.session_state.completed = 0
                st.session_state.phase = 'lhs'
                st.session_state.sor_iteration = 0
                st.experimental_rerun()

    else:
        st.subheader("ðŸ“Š Experiment Status")

        if st.session_state.phase == 'lhs':
            st.metric("Phase", "LHS")
            st.metric("Progress", f"{st.session_state.completed}/{st.session_state.num_lhs}")
            st.progress(st.session_state.completed / st.session_state.num_lhs)
        elif st.session_state.phase == 'sor':
            st.metric("Phase", "SOR")
            st.metric("Progress", f"{st.session_state.sor_iteration}/{st.session_state.num_sor_iterations}")
            st.progress(st.session_state.sor_iteration / st.session_state.num_sor_iterations)
        elif st.session_state.phase == 'completed':
            st.metric("Phase", "âœ… COMPLETED")

        st.markdown("---")

        # Show objectives configuration
        st.subheader("Objectives Configuration")
        for i, obj in enumerate(st.session_state.objectives):
            if i == 0:
                obj_type = "Yield"
            else:
                obj_type = f"Impurity {i}"

            st.text(f"{obj['name']} ({obj_type})")
            st.text(f"  RT: [{st.session_state.rtmin_list[i]:.2f} - {st.session_state.rtmax_list[i]:.2f}]")
            st.text(f"  {('Maximize' if obj['maximize'] else 'Minimize')}")

        st.text(f"\nInternal Standard:")
        st.text(f"  RT: [{st.session_state.iso_rtmin:.2f} - {st.session_state.iso_rtmax:.2f}]")

        st.markdown("---")

        if st.button("ðŸ”„ Reset Experiment"):
            for key in list(st.session_state.keys()):
                del st.session_state[key]
            st.experimental_rerun()

# Main content area
if st.session_state.phase == 'setup':
    st.info("ðŸ‘ˆ Please configure your experiment in the sidebar to get started")

    st.markdown("""
    ### How to use this testing tool:

    1. **Upload LHS Data**: Upload your LHS-generated Excel/CSV file with input variables (flowrates, temperatures, etc.)
    2. **Define Objectives**:
       - First objective = Yield (RT range where your product peak appears)
       - Additional objectives = Impurities (RT ranges for impurity peaks)
    3. **Set Internal Standard**: Define the RT range for your internal standard peak
    4. **Set SOR Iterations**: How many SOR experiments to run after LHS phase
    5. **Click "Start Experiment"** to begin
    6. **Upload HPLC files** one by one for each experiment
    7. Watch the table update with objective values in real-time!

    ### Expected HPLC File Format:
    - CSV file with columns: `RT` and `Area` (or `Peak Area`)
    - Each row represents one peak with its retention time and area
    """)

elif st.session_state.phase in ['lhs', 'sor']:
    col1, col2 = st.columns([2, 1])

    with col1:
        st.subheader("ðŸ“Š Current Experiment Data")

        # Display current data
        if st.session_state.experiment_data is not None:
            st.dataframe(st.session_state.experiment_data, height=400)

    with col2:
        st.subheader("ðŸ“ Upload HPLC File")

        if st.session_state.phase == 'lhs':
            current_exp = st.session_state.completed + 1
            st.info(f"**LHS Experiment {current_exp}/{st.session_state.num_lhs}**")
        else:
            current_exp = st.session_state.sor_iteration + 1
            st.info(f"**SOR Iteration {current_exp}/{st.session_state.num_sor_iterations}**")

        hplc_file = st.file_uploader(
            "Upload HPLC CSV file",
            type=['csv'],
            key=f"hplc_{st.session_state.completed}_{st.session_state.sor_iteration}"
        )

        if hplc_file:
            st.success(f"âœ… File uploaded: {hplc_file.name}")

            # Show preview of HPLC data
            with st.expander("ðŸ“‹ HPLC Data Preview"):
                df_hplc = pd.read_csv(hplc_file)
                st.dataframe(df_hplc.head(10))

                if 'RT' in df_hplc.columns:
                    st.text(f"RT range: {df_hplc['RT'].min():.3f} - {df_hplc['RT'].max():.3f}")
                if 'Area' in df_hplc.columns or 'Peak Area' in df_hplc.columns:
                    area_col = 'Area' if 'Area' in df_hplc.columns else 'Peak Area'
                    st.text(f"Total peaks: {len(df_hplc)}")

            if st.button("ðŸ”¬ Process HPLC File"):
                with st.spinner("Processing HPLC data..."):
                    try:
                        # Reset file pointer to beginning before reading again
                        hplc_file.seek(0)
                        # Read HPLC file
                        df_hplc = pd.read_csv(hplc_file)

                        # Extract RT parameters
                        YminRT = st.session_state.rtmin_list[0]
                        YmaxRT = st.session_state.rtmax_list[0]
                        IminRT_list = st.session_state.rtmin_list[1:]
                        ImaxRT_list = st.session_state.rtmax_list[1:]

                        # Process HPLC file
                        resp = utils.process_uploaded_csv_file(
                            hplc_file.name,
                            df_hplc,
                            st.session_state.iso_rtmin,
                            st.session_state.iso_rtmax,
                            YminRT,
                            YmaxRT,
                            IminRT_list,
                            ImaxRT_list,
                            st.session_state.objectives,
                            st.session_state.experiment_data
                        )

                        st.success("âœ… HPLC processing completed!")

                        # Display calculated responses
                        st.subheader("ðŸ“ˆ Calculated Objective Values")
                        for i, (obj, val) in enumerate(zip(st.session_state.objectives, resp)):
                            obj_type = "Yield" if i == 0 else f"Impurity {i}"
                            st.metric(
                                f"{obj['name']} ({obj_type})",
                                f"{val:.4f}",
                                help=f"RT range: [{st.session_state.rtmin_list[i]:.2f} - {st.session_state.rtmax_list[i]:.2f}]"
                            )

                        # Update experiment data
                        current_row_idx = st.session_state.completed
                        for i, obj in enumerate(st.session_state.objectives):
                            st.session_state.experiment_data.at[current_row_idx, obj['name']] = resp[i]

                        st.session_state.completed += 1

                        # Check phase transition
                        if st.session_state.phase == 'lhs' and st.session_state.completed >= st.session_state.num_lhs:
                            st.success("ðŸŽ‰ LHS Phase Completed! Moving to SOR Phase...")

                            # Generate first SOR row
                            with st.spinner("Generating first SOR experiment..."):
                                sor_df = utils.generate_multiple_sor_rows(
                                    1,
                                    st.session_state.objectives,
                                    st.session_state.experiment_data
                                )
                                st.session_state.experiment_data = sor_df
                                st.session_state.phase = 'sor'
                                st.session_state.sor_iteration = 0

                            st.balloons()

                        elif st.session_state.phase == 'sor':
                            st.session_state.sor_iteration += 1

                            if st.session_state.sor_iteration < st.session_state.num_sor_iterations:
                                # Generate next SOR row
                                with st.spinner(f"Generating SOR iteration {st.session_state.sor_iteration + 1}..."):
                                    sor_df = utils.generate_multiple_sor_rows(
                                        1,
                                        st.session_state.objectives,
                                        st.session_state.experiment_data
                                    )
                                    st.session_state.experiment_data = sor_df
                            else:
                                # All SOR iterations completed
                                st.session_state.phase = 'completed'
                                st.success("ðŸŽ‰ All experiments completed!")
                                st.balloons()

                        st.experimental_rerun()

                    except Exception as e:
                        st.error(f"âŒ Error processing HPLC file: {str(e)}")
                        import traceback
                        with st.expander("ðŸ“‹ Error Details"):
                            st.code(traceback.format_exc())

elif st.session_state.phase == 'completed':
    st.success("ðŸŽ‰ All Experiments Completed!")

    st.subheader("ðŸ“Š Final Results")
    st.dataframe(st.session_state.experiment_data, height=600)

    # Download results
    col1, col2 = st.columns(2)
    with col1:
        csv = st.session_state.experiment_data.to_csv(index=False)
        st.download_button(
            label="ðŸ“¥ Download as CSV",
            data=csv,
            file_name=f"sor_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
            mime="text/csv"
        )

    with col2:
        # Convert to Excel bytes
        from io import BytesIO
        output = BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            st.session_state.experiment_data.to_excel(writer, index=False, sheet_name='Results')
        excel_data = output.getvalue()

        st.download_button(
            label="ðŸ“¥ Download as Excel",
            data=excel_data,
            file_name=f"sor_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

    # Summary statistics
    st.subheader("ðŸ“ˆ Summary Statistics")

    obj_cols = [obj['name'] for obj in st.session_state.objectives]
    if obj_cols:
        summary_df = st.session_state.experiment_data[obj_cols].describe()
        st.dataframe(summary_df)

        # Show best experiments
        st.subheader("ðŸ† Best Results")
        for obj in st.session_state.objectives:
            col1, col2 = st.columns(2)
            with col1:
                if obj['maximize']:
                    best_idx = st.session_state.experiment_data[obj['name']].astype(float).idxmax()
                    best_val = st.session_state.experiment_data[obj['name']].iloc[best_idx]
                    st.metric(
                        f"Best {obj['name']} (Maximize)",
                        f"{best_val:.4f}",
                        delta=f"Row {best_idx + 1}"
                    )
                else:
                    best_idx = st.session_state.experiment_data[obj['name']].astype(float).idxmin()
                    best_val = st.session_state.experiment_data[obj['name']].iloc[best_idx]
                    st.metric(
                        f"Best {obj['name']} (Minimize)",
                        f"{best_val:.4f}",
                        delta=f"Row {best_idx + 1}"
                    )

# Footer
st.markdown("---")
st.caption("ðŸ§ª SOR HPLC Testing Tool - Local Testing Environment")
