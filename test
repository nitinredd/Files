// src/api.js
import axios from "axios";

/**
 * API_BASE:
 * - If your frontend is served from the same origin (e.g. proxying to backend), keep "".
 * - If your backend runs at a different host / port, set it here (e.g. "http://localhost:8000").
 */
export const API_BASE = ""; // <-- set to backend base if needed, e.g. "http://localhost:8000"

const api = axios.create({
  baseURL: API_BASE || "",
  timeout: 60000,
});

// Helper to normalize axios responses (unwrap .data if present)
const unwrap = (res) => {
  if (res === undefined || res === null) return res;
  return res.data !== undefined ? res.data : res;
};

// ===== Upload file =====
// Backend expects form fields: "file" and "reaction_type" (underscore, not space).
// This function returns the backend JSON or throws an error.
export const uploadFile = async (file, reaction_type = "Miscellaneous", filename = null) => {
  if (!file) throw new Error("No file provided");
  const fd = new FormData();
  fd.append("file", file);
  // IMPORTANT: backend expects "reaction_type" exactly (underscore). Previous bug used "reaction type".
  fd.append("reaction_type", reaction_type);
  if (filename) fd.append("filename", filename);

  const res = await api.post("/upload", fd, {
    headers: { "Content-Type": "multipart/form-data" },
  });
  return unwrap(res);
};

// ===== Prompt gallery =====
export const fetchPrompts = async () => {
  const res = await api.get("/prompt-gallery");
  const data = unwrap(res) || {};
  // backend returns { prompts: [...] }
  const raw = Array.isArray(data) ? data : data.prompts || [];
  // normalize to { id, title, text }
  return (raw || []).map((p, idx) => ({
    id: p.id || `prompt-${idx}`,
    title: p.title || p.name || `Prompt ${idx + 1}`,
    text: p.prompt || p.text || p.query || "",
  }));
};

// ===== Other helpers =====
export const fetchReactions = async () => unwrap(await api.get("/reactions"));
export const fetchProducts = async (reactionType) => unwrap(await api.get("/products", { params: reactionType ? { reaction_type: reactionType } : {} }));
export const fetchProductMeta = async (productId) => unwrap(await api.get(`/product/${encodeURIComponent(productId)}/meta`));
export const fetchProductDetails = async (productId = undefined, question = "Extract API Name, Reaction Chemistry, Yield, Procedure, and Tabular Data", session_id = undefined) => {
  const payload = { question };
  if (productId) payload.product_id = productId;
  if (session_id) payload.session_id = session_id;
  return unwrap(await api.post("/product/details", payload));
};
export const fetchSchemeImageUrl = (productId) => `${API_BASE || ""}/product/${encodeURIComponent(productId)}/scheme-image`;
export const searchProducts = async (q, limit = 10) => unwrap(await api.get("/products/search", { params: { q, limit } }));
export const queryWithCitations = async (productIds = [], question = "", session_id = undefined) => {
  const payload = { product_ids: productIds, question };
  if (session_id) payload.session_id = session_id;
  return unwrap(await api.post("/query", payload));
};

export default api;
