import streamlit as st
import speech_recognition as sr
from gtts import gTTS
import io

st.set_page_config(page_title="STT + gTTS TTS", layout="centered")
st.title("Speech-to-Text + Read-Aloud (No Native Models)")

recognizer = sr.Recognizer()

def recognize_google_stt():
    with sr.Microphone() as source:
        st.info("ğŸ™ï¸ Listeningâ€¦ speak now")
        audio = recognizer.listen(source, phrase_time_limit=5)
        st.success("ğŸ” Processingâ€¦")

    try:
        # Google Web Speech API (free, no model download)
        return recognizer.recognize_google(audio)
    except sr.UnknownValueError:
        return "ğŸ˜• Sorry, could not understand audio."
    except sr.RequestError as e:
        return f"âš ï¸ STT request failed; {e}"

def tts_stream(text: str):
    buf = io.BytesIO()
    gTTS(text).write_to_fp(buf)
    buf.seek(0)
    return buf

# session state to hold transcript
if "transcript" not in st.session_state:
    st.session_state.transcript = ""

if st.button("â–¶ï¸ Start Listening"):
    st.session_state.transcript = recognize_google_stt()

if st.session_state.transcript:
    st.subheader("ğŸ“ Recognized Text")
    st.text_area("", value=st.session_state.transcript, height=100)

    if st.button("ğŸ”Š Read Aloud"):
        mp3_bytes = tts_stream(st.session_state.transcript)
        st.audio(mp3_bytes, format="audio/mp3")
