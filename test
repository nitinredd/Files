import os
import google.auth
import pandas as pd
import streamlit as st
from vertexai.preview.generative_models import GenerativeModel, SafetySetting, HarmCategory, HarmBlockThreshold

# ---------- Configuration ----------
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "D:/datascience-254609-genai.json"
credentials, project_id = google.auth.default()

# Initialize Gemini 2.5 Pro (using flash-thinking as placeholder)
model = GenerativeModel("gemini-2.0-flash-thinking-exp-01-21")

# Safety settings
safety_config = [
    SafetySetting(category=HarmCategory.HARM_CATEGORY_UNSPECIFIED, threshold=HarmBlockThreshold.BLOCK_NONE),
    SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_NONE),
    SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_NONE),
    SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_NONE),
    SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_NONE),
]

# ---------- Multi-Agent Framework ----------
class Agent:
    """Base class for agents"""
    def __init__(self, name):
        self.name = name
    def handle(self, query, context):
        raise NotImplementedError

class ExcelReaderAgent(Agent):
    """Reads structured data from Excel workbooks"""
    def __init__(self, files):
        super().__init__("ExcelReader")
        self.sheets = {}
        for f in files:
            xl = pd.ExcelFile(f)
            for sheet in xl.sheet_names:
                self.sheets[sheet] = xl.parse(sheet)

    def handle(self, query, context):
        # Provide sheet keys to coordinator
        return list(self.sheets.keys())

class QueryAgent(Agent):
    """Extracts relevant rows matching user intent"""
    def __init__(self, reader: ExcelReaderAgent):
        super().__init__("QueryAgent")
        self.reader = reader

    def handle(self, query, context):
        results = {}
        for sheet, df in self.reader.sheets.items():
            # naive contains search across all columns
            mask = df.apply(lambda col: col.astype(str).str.contains(query, case=False, na=False)).any(axis=1)
            matched = df[mask]
            if not matched.empty:
                results[sheet] = matched
        return results

class GeminiAgent(Agent):
    """Calls Gemini to refine/answer based on extracted rows"""
    def __init__(self, model, safety_settings):
        super().__init__("GeminiAgent")
        self.model = model
        self.safety = safety_settings

    def handle(self, query, context):
        # Build prompt from context rows
        prompt = f"You are a domain assistant.\nUser query: {query}\nRelevant data:"
        for sheet, df in context.items():
            prompt += f"\nSheet: {sheet}, Rows: {df.to_dict(orient='list')}"
        resp = self.model.generate_content([prompt], safety_settings=self.safety)
        return resp[0].text if resp else "No answer generated"

class CoordinatorAgent(Agent):
    """Orchestrates workflow among agents"""
    def __init__(self, reader, query_agent, gemini_agent):
        super().__init__("Coordinator")
        self.reader = reader
        self.query_agent = query_agent
        self.gemini_agent = gemini_agent

    def handle(self, query):
        # Step 1: extract potential sheets
        sheets = self.reader.handle(query, None)
        # Step 2: detailed row matching
        matched = self.query_agent.handle(query, None)
        if not matched:
            return None, None
        # Step 3: call Gemini
        answer = self.gemini_agent.handle(query, matched)
        return answer, matched

# ---------- Streamlit App ----------
st.set_page_config(page_title="Excel Chatbot", layout="wide")

# Initialize or load agents
if 'agents' not in st.session_state:
    files = ['formula master_osd.xlsx', 'masterlist osd equipments.xlsx']
    reader = ExcelReaderAgent(files)
    query_agent = QueryAgent(reader)
    gemini_agent = GeminiAgent(model, safety_config)
    coordinator = CoordinatorAgent(reader, query_agent, gemini_agent)
    st.session_state['agents'] = {'coordinator': coordinator, 'reader': reader}

coordinator = st.session_state['agents']['coordinator']
reader = st.session_state['agents']['reader']

# Greeting and sample prompts
if 'greeted' not in st.session_state:
    st.write("**Hi! I'm your Excel Chatbot powered by Gemini 2.5 Pro.**")
    # dynamic sample prompts based on sheet data
    samples = []
    # pick first 3 sheets and first row values
    for sheet, df in list(reader.sheets.items())[:3]:
        row = df.iloc[0].to_dict()
        key, val = list(row.items())[0]
        samples.append(f"Do we have {key} with value {val} in {sheet}?")
    st.markdown("**Try these prompts:**")
    for s in samples:
        st.write(f"- {s}")
    st.session_state['greeted'] = True

# User input
query = st.text_input("Enter your query:")
if st.button("Ask") and query:
    with st.spinner("Processing..."):
        answer, matched = coordinator.handle(query)
        if matched is None:
            st.error("Relevant information not found in the Excel workbooks.")
        else:
            # Display table results
            st.subheader("Matched Data")
            for sheet, df in matched.items():
                st.write(f"**Sheet: {sheet}**")
                st.dataframe(df)
            # Display Gemini answer
            st.subheader("Answer")
            st.write(answer)
