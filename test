import streamlit as st
from moviepy.editor import VideoFileClip, AudioFileClip
import tempfile
import os
from pathlib import Path
import shutil

def process_video(video_file, audio_file, output_dir):
    """Replace audio in video with new audio file"""
    try:
        # Create temporary directory for processing
        temp_dir = tempfile.mkdtemp()
        
        # Save uploaded files to temporary directory
        temp_video_path = os.path.join(temp_dir, "temp_video.mp4")
        temp_audio_path = os.path.join(temp_dir, "temp_audio.mp3")
        
        # Create output directory if it doesn't exist
        os.makedirs(output_dir, exist_ok=True)
        output_path = os.path.join(output_dir, "spanish_video.mp4")
        
        # Save uploaded files
        with open(temp_video_path, "wb") as f:
            f.write(video_file.read())
        with open(temp_audio_path, "wb") as f:
            f.write(audio_file.read())
            
        # Load video and audio
        video = VideoFileClip(temp_video_path)
        new_audio = AudioFileClip(temp_audio_path)
        
        # If audio is longer/shorter than video, adjust it to video duration
        if new_audio.duration != video.duration:
            new_audio = new_audio.set_duration(video.duration)
        
        # Replace audio
        final_video = video.set_audio(new_audio)
        
        # Write output video to user-selected directory
        final_video.write_videofile(
            output_path,
            codec='libx264',
            audio_codec='aac',
            temp_audiofile=os.path.join(output_dir, 'temp-audio.m4a'),
            remove_temp=True
        )
        
        # Close clips to free up resources
        video.close()
        new_audio.close()
        final_video.close()
        
        # Clean up temporary directory
        shutil.rmtree(temp_dir)
        
        return output_path
        
    except Exception as e:
        if 'temp_dir' in locals():
            shutil.rmtree(temp_dir)
        raise e

def main():
    st.title("Video Audio Replacement Tool")
    st.write("Upload a video and a Spanish audio file to replace the original audio")
    
    # File uploaders
    video_file = st.file_uploader("Upload Video", type=['mp4'])
    audio_file = st.file_uploader("Upload Spanish Audio", type=['mp3'])
    
    # Output directory selection
    st.write("Select Output Directory")
    output_dir = st.text_input("Output Directory Path", 
                              value=str(Path.home() / "Videos"),
                              help="Enter the full path where you want to save the processed video")
    
    if video_file and audio_file:
        if st.button("Replace Audio"):
            try:
                with st.spinner("Processing... This may take a few minutes."):
                    # Process the video
                    output_path = process_video(video_file, audio_file, output_dir)
                    
                    # Show success message with file location
                    st.success(f"Processing complete! Video saved to: {output_path}")
                    
                    # Add open folder button
                    if st.button("Open Output Folder"):
                        try:
                            if os.name == 'nt':  # Windows
                                os.system(f'explorer "{os.path.dirname(output_path)}"')
                            elif os.name == 'posix':  # macOS and Linux
                                os.system(f'open "{os.path.dirname(output_path)}"')
                        except Exception as e:
                            st.warning(f"Could not open folder automatically. Please navigate to: {output_path}")
                    
            except Exception as e:
                st.error(f"An error occurred: {str(e)}")
                
    # Add helpful information
    st.markdown("""
    ### Notes:
    - The output directory must be a valid path on your system
    - Make sure you have write permissions for the selected directory
    - The default directory is your Videos folder
    - The output video will be named 'spanish_video.mp4'
    """)

if __name__ == "__main__":
    main()
